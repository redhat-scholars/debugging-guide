<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Debugger, please Help Me! :: OpenShift Debugging Workshop</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/course-template/debugging/5.0/live-debugging.html">
    <link rel="prev" href="perform-trace-analysis.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://redhat-scholars.github.io/course-template">OpenShift Debugging Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="debugging" data-version="5.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">OpenShift Debugging Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="introduction.html">1. Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="developer-workspace.html">2. You are not alone</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="reproduce-environment.html">3. The past is relevant only as data</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="visualize-service-mesh.html">4. Blindfolded debugging&#8230;&#8203; Not today</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="perform-trace-analysis.html">5. Trace Within a Trace</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="live-debugging.html">6. Debugger, please Help Me!</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OpenShift Debugging Workshop</span>
    <span class="version">5.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">OpenShift Debugging Workshop</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">5.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">OpenShift Debugging Workshop</a></li>
    <li><a href="live-debugging.html">6. Debugger, please Help Me!</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/debugging-guide/edit/5.0/documentation/modules/ROOT/pages/live-debugging.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Debugger, please Help Me!</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>20 MINUTES PRACTICE</em></p>
</div>
<div class="paragraph">
<p>After checking logs and traces we need the ability to do live debugging of my application,
it&#8217;s an essential piece in the development process. It&#8217;s time to enter the running system.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_is_kibana"><a class="anchor" href="#_what_is_kibana"></a>What is Kibana?</h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="imageblock">
<div class="content">
<img src="_images/Kibana-Logo-Color-H.png" alt="Kibana" width="300">
</div>
</div>
<div class="paragraph">
<p>OpenShift provides a logging solution based on ElasticSearch, Fluentd, and <a href="https://www.elastic.co/kibana" target="_blank" rel="noopener">Kibana</a> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Fluentd</strong> which serves as both the collector and the normalizer,</p>
</li>
<li>
<p><strong>Elasticsearch</strong> serves as the warehouse (aggregation and storage), and</p>
</li>
<li>
<p><strong>Kibana</strong> is the visualizer (web UI). <strong>Kibana</strong> is a Node.js application. It works very well with Elasticsearch and is tightly coupled to it.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/logging-stack.png" alt="Logging Stack" width="500">
</div>
</div>
<div class="paragraph">
<p>The logging system can provide two views:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Project logs</strong> - access controlled view to specific project logs for running containers and project resources. Our case in this Workshop.</p>
</li>
<li>
<p><strong>Ops view</strong> - aggregate logging of all projects across the cluster, in addition to platform logs (nodes, docker, and masters, for example).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://docs.openshift.com/container-platform/3.11/install_config/aggregate_logging.html#aggregate-logging-kibana" target="_blank" rel="noopener">Additional information</a></p>
</div>
<div class="paragraph">
<p>Log management plays a vital role when we encounter an error in the application. If we do not manage the logs, it will be difficult in any application, especially in microservices architecture, to find the problem and fix it. For our application with lots of microservices we have to identify interesting traces and Kibana is offering
nice User Interface with a search field to explore and to analyze logs files easily. Whenever we get some error in the application(s), we can get the error details and analyze them in a simple way.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_investigate_the_bug"><a class="anchor" href="#_investigate_the_bug"></a>Investigate The Bug</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The coolStore application seems to have a bug that causes the inventory status for one of the products not to be displayed on the page.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/debug-coolstore-bug.png" alt="Inventory Status Bug" width="800">
</div>
</div>
<div class="paragraph">
<p><strong>This is not an expected behavior!</strong> Let&#8217;s start our investigation from the application logs!</p>
</div>
<div class="paragraph">
<p><code><strong>Log in to the <a href="https://kibana-openshift-logging.%APPS_HOSTNAME_SUFFIX%" class="params-link" target="_blank" rel="noopener">Kibana Console</a> as user%USER_ID%/%OPENSHIFT_PASSWORD%</strong></code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/kibana-console.png" alt="Kibana - Console" width="600">
</div>
</div>
<div class="paragraph">
<p>After you log in, enter the following configuration:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Kibana Search</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Search</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>message:(inventory AND error)</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Selected fields</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>kubernetes.pod_name</strong>, <strong>message</strong></p></td>
</tr>
</tbody>
</table>
<div class="imageblock">
<div class="content">
<img src="_images/kibana-search.png" alt="Kibana - Search" width="200">
</div>
</div>
<div class="paragraph">
<p><code><strong>Press Enter</strong></code>, you will get the following results:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/kibana-error-result.png" alt="Kibana - Error Result" width="600">
</div>
</div>
<div class="paragraph">
<p>Oh! Something seems to be wrong with the response the <strong>Gateway Service</strong> has received from the <strong>Inventory Service</strong> for the product id <strong>'444436'</strong>.
But there doesn&#8217;t seem to be anything relevant to the <strong>invalid response</strong> error at the <strong>Inventory Service</strong> level!</p>
</div>
<div class="paragraph">
<p>From <a href="https://jaeger-istio-system.%APPS_HOSTNAME_SUFFIX%" class="params-link" target="_blank" rel="noopener">Jaeger Console</a>, <code><strong>select one of the trace and enter the product ID '444436' in the 'Find&#8230;&#8203;' field on the top bar</strong></code>.</p>
</div>
<div class="paragraph">
<p>One span should be highlighted in <strong>light yellow</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jaeger-trace-inventory.png" alt="Jaeger - Trace Inventory" width="600">
</div>
</div>
<div class="paragraph">
<p><code><strong>Expand the 'inventory.staging-project%USER_ID%' span</strong></code> in order to get more detail.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jaeger-trace-inventory-details.png" alt="Jaeger - Trace Inventory" width="800">
</div>
</div>
<div class="paragraph">
<p>No response came back from <strong>Inventory Service</strong> for the product id <strong>444436</strong> and that seems to be the reason the inventory status is not displayed.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s debug the <strong>Inventory Service</strong> to get to the bottom of this!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_debugging_with_codeready_workspaces_and_istio_workspace"><a class="anchor" href="#_debugging_with_codeready_workspaces_and_istio_workspace"></a>Debugging with CodeReady Workspaces and Istio Workspace</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Similarly to previous lab, we will leverage <strong>Istio Workspace</strong> tool to start <strong>Inventory Service</strong>, connect to actual production cluster and debug the code.</p>
</div>
<div class="paragraph">
<p>First, we have to start Quarkus-based <strong>Inventory Service</strong> in the <strong>Dev</strong> mode. This is achieved by <em>quarkus:dev</em> Maven goal.
This will allow us to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>attach the debugger to running service.</p>
</li>
<li>
<p>reload code without restarts.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We will also set header to <strong>live_debug</strong>, so we can reach our instance and debug it where all the other users will still rely on the production instance.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Having debugger attached to the production instance will result in halting the whole system for every user. We definitely don&#8217;t want this to happen. That&#8217;s why <code>Istio Workspace</code> was born.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In your <a href="http://codeready-workspaces.%APPS_HOSTNAME_SUFFIX%" class="params-link" target="_blank" rel="noopener">Workspace</a>,</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_ide-task"></a>IDE Task</p>
</li>
<li>
<p><a id="tabset1_cli"></a>CLI</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_ide-task">
<div class="paragraph">
<p><code><strong>Click on 'Terminal' &#8594; 'Run Task&#8230;&#8203;' &#8594;  'Inventory - Route Traffic to local'</strong></code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/che-runtask.png" alt="Che - RunTask" width="500">
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_cli">
<div class="paragraph">
<p><code><strong>Execute the following commands in the '&gt;_ workshop_tools' terminal window</strong></code></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To open a '&gt;_ workshop_tools' terminal window, <code><strong>click on 'Terminal' &#8594; 'Open Terminal in specific container' &#8594;  'workshop-tools'</strong></code>
</td>
</tr>
</table>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd /projects/workshop/inventory-quarkus
ike develop \
    --deployment inventory-v1 \
    --run 'mvn compile quarkus:dev' \
    --port 8080:8080 \
    --route header:ike-session-id=live_debug</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
you kill all current <strong>ike</strong> process with the command: <code>pkill ike</code>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Next, you start debugging by <code><strong>clicking on Run &#8594; Start Debugging</strong></code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/che-debugmode.png" alt="Che - Debug Mode" width="700">
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The debugger works with <a href="https://marketplace.visualstudio.com/items?itemName=redhat.java" target="_blank" rel="noopener">Language Support for Java&#8482; by Red Hat</a> (the language server) for source mapping
and project support. Ensure the language server is loaded correctly by checking the 👍 icon at the right side of the status bar.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In your <a href="http://codeready-workspaces.%APPS_HOSTNAME_SUFFIX%" class="params-link" target="_blank" rel="noopener">Workspace</a>,
<code><strong>open the 'Explorer' view in the left menu and edit the 'com.redhat.cloudnative.inventory.InventoryResource' class
in the 'inventory-quarkus' project</strong></code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/che-breakpoint.png" alt="Che - Breakpoint" width="700">
</div>
</div>
<div class="paragraph">
<p><code><strong>Add a breakpoint by clicking on the editor sidebar on the line number of the first line of the 'getAvailability()'
method</strong></code>.</p>
</div>
<div class="paragraph">
<p>Additionally, we can narrow breakpoint capture by enabling a condition <strong>itemId.equals("444436")</strong>.
<code><strong>Right-click on the breakpoint and select 'Edit Breakpoint&#8230;&#8203;' option</strong></code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/che-conditional-breakpoint.png" alt="Che - Edit Breakpoint" width="700">
</div>
</div>
<div class="paragraph">
<p>Then <code><strong>add expression mentioned above - <strong>itemId.equals("444436")</strong> - and hit 'ENTER'</strong></code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/che-conditional-breakpoint-condition.png" alt="Che - Conditional Breakpoint" width="700">
</div>
</div>
<div class="paragraph">
<p>We can now access the Coolstore application with the new route to see if we can reach the breakpoint.</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">http://web-staging-project%USER_ID%.%APPS_HOSTNAME_SUFFIX%/#!/?route=live_debug</code></pre>
</div>
</div>
<div class="paragraph">
<p>The IDE will automatically switch back to the <strong>Debug Panel</strong> and notice that the code execution is paused at the
breakpoint on <strong>InventoryResource</strong> class.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/che-breakpointstop.png" alt="Che - Breakpoint Stop" width="900">
</div>
</div>
<div class="paragraph">
<p><code><strong>Click on the <strong>Step Over</strong> icon</strong></code> to execute one line and retrieve the inventory object for the
given product id from the database.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/che-stepover.png" alt="Che - Step Over" width="900">
</div>
</div>
<div class="paragraph">
<p><strong>Can you spot the bug now?</strong>
<code><strong>Look at the 'Variables' window on the left-hand side</strong></code>. The retrieved <strong>inventory</strong> object is <strong>null</strong>!</p>
</div>
<div class="paragraph">
<p>The non-existing product id is not a problem on its own. It simply could mean this product is discontinued and removed
from the Inventory database, but it&#8217;s not removed from the product catalog database yet.
However, the bug occurs because the code returns <strong>null</strong> value instead of a sensible REST response.
If the product id does not exist, a proper JSON response stating a zero inventory should be  returned instead of <strong>null</strong>.</p>
</div>
<div class="paragraph">
<p><code><strong>Click on the 'Resume' icon then on the 'Stop' icon</strong></code> to end the debugging session.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/che-end.png" alt="Che - End" width="900">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_fix_the_bug"><a class="anchor" href="#_fix_the_bug"></a>Fix the Bug</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In your <a href="http://codeready-workspaces.%APPS_HOSTNAME_SUFFIX%" class="params-link" target="_blank" rel="noopener">Workspace</a>, under the <strong>inventory-quarkus</strong> project,
<code><strong>update the <strong>getAvailability()</strong> method of the <strong>InventoryResource</strong> class as follows</strong></code>:</p>
</div>
<div class="listingblock copypaste">
<div class="title">InventoryResource.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@GET
@Path("/{itemId}")
@Produces(MediaType.APPLICATION_JSON)
public Inventory getAvailability(@PathParam("itemId") String itemId) {
    Inventory inventory = em.find(Inventory.class, itemId);

    if (inventory == null) { <i class="conum" data-value="1"></i><b>(1)</b>
        inventory = new Inventory();
        inventory.setItemId(itemId);
        inventory.setQuantity(0);
    }

    return inventory;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>handles the 'null' value for the inventory entity</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After changing the code, <code><strong>please access the Coolstore application with the 'route=live_debug' header</strong></code> and
to verify how it works now.</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">http://web-staging-project%USER_ID%.%APPS_HOSTNAME_SUFFIX%/#!/?route=live_debug</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/debug-coolstore-bug-fixed.png" alt="Inventory Status Bug Fixed" width="800">
</div>
</div>
<div class="paragraph">
<p><strong>If it looks ok we are ready to roll it out to production!</strong></p>
</div>
<div class="paragraph">
<p><code><strong>You can now stop ike process in the terminal by pressing Ctrl+C</strong></code>. This will result in undeploying our special instance which we just used for debugging purposes.</p>
</div>
<div class="paragraph">
<p>Well done and congratulations for completing all the labs.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="perform-trace-analysis.html" class="query-params-link">5. Trace Within a Trace</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
