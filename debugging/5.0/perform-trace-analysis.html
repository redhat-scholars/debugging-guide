<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: OpenShift Debugging Workshop</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/course-template/debugging/5.0/perform-trace-analysis.html">
    <link rel="prev" href="visualize-service-mesh.html">
    <link rel="next" href="live-debugging.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://redhat-scholars.github.io/course-template">OpenShift Debugging Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="debugging" data-version="5.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">OpenShift Debugging Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="introduction.html">1. Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="developer-workspace.html">2. You are not alone</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="reproduce-environment.html">3. The past is relevant only as data</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="visualize-service-mesh.html">4. Blindfolded debugging&#8230;&#8203; Not today</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="perform-trace-analysis.html">5. Trace Within a Trace</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="live-debugging.html">6. Please Help Me!</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OpenShift Debugging Workshop</span>
    <span class="version">5.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">OpenShift Debugging Workshop</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">5.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">OpenShift Debugging Workshop</a></li>
    <li><a href="perform-trace-analysis.html">5. Trace Within a Trace</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/debugging-guide/edit/5.0/documentation/modules/ROOT/pages/perform-trace-analysis.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="_dream_within_a_dream"><a class="anchor" href="#_dream_within_a_dream"></a>"Dream Within a Dream"</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>20 MINUTES PRACTICE</em></p>
</div>
<div class="paragraph">
<p>As Cobb and Arthur in <strong>Inception</strong>, let&#8217;s perform a <strong>"Trace Within a Trace" Strategy</strong> called <strong>Distributed Tracing</strong> using Red Hat OpenShift Container Platform to infiltrate the application traces and extract valuable information to solve the issues</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/inception.jpg" alt="Inception" width="500">
</div>
</div>
<div class="paragraph text-center">
<p><a href="https://wallpapercave.com/wp/ZDpGHyX.jpg" target="_blank" rel="noopener">Source: https://wallpapercave.com/wp/ZDpGHyX.jpg</a></p>
</div>
<div class="sect2">
<h3 id="_what_is_jaeger"><a class="anchor" href="#_what_is_jaeger"></a>What is Jaeger?</h3>
<div class="sidebarblock">
<div class="content">
<div class="imageblock">
<div class="content">
<img src="_images/images/jaeger-logo.png" alt="Jaeger" width="400">
</div>
</div>
<div class="paragraph">
<p><a href="https://www.jaegertracing.io" target="_blank" rel="noopener">Jaeger Tracing</a>, inspired by Dapper and OpenZipkin, is a distributed tracing system released as open source by Uber Technologies. It is used for monitoring and troubleshooting microservices-based distributed systems, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Distributed context propagation</p>
</li>
<li>
<p>Distributed transaction monitoring</p>
</li>
<li>
<p>Root cause analysis</p>
</li>
<li>
<p>Service dependency analysis</p>
</li>
<li>
<p>Performance / latency optimization</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://www.kiali.io" target="_blank" rel="noopener">Kiali</a> includes <a href="https://www.jaegertracing.io" target="_blank" rel="noopener">Jaeger Tracing</a> to provide distributed tracing out of the box.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_what_are_you_hidding_mrmrs_application"><a class="anchor" href="#_what_are_you_hidding_mrmrs_application"></a>What are you hidding, Mr/Mrs <strong>Application</strong>?</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Because of certificates issues, you need first to access the main {{ JAEGER_URL }}[Jaeger Console^] to use it through Kiali.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>From the {{ KIALI_URL }}[Kiali Console^], <code><strong>click on the 'Distributed Tracing'</strong></code> in the left navigation and enter the following configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Select a Namespace: <strong>{{ COOLSTORE_PROJECT }}</strong></p>
</li>
<li>
<p>Select a Service: <strong>gateway</strong></p>
</li>
<li>
<p>Then click on the <strong>'Search Traces' button</strong> on the right</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/jaeger-query.png" alt="Jaeger - Query" width="800">
</div>
</div>
<div class="paragraph">
<p>By default, <strong>Service Mesh</strong> automatically sends collected tracing data to Jaeger, so that we are able to <strong>only see individual trace</strong> (one-to-one service call).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>1 individual trace for <strong>Gateway Service</strong> &#8594; <strong>Catalog Service</strong></p>
</li>
<li>
<p>7 individual traces for <strong>Gateway Service</strong> &#8594; <strong>Inventory Service</strong></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/jaeger-trace-2spans-view.png" alt="Jaeger - Traces View" width="800">
</div>
</div>
<div class="paragraph">
<p>As you have called several times the <strong>Gateway Service</strong> through the Web UI, you find much more than 8 spans in Jaeger and you cannot easily observe the entire trace for an end-to-end request.</p>
</div>
</div>
<div class="sect2">
<h3 id="_enabling_distributed_context_propagation"><a class="anchor" href="#_enabling_distributed_context_propagation"></a>Enabling Distributed Context Propagation</h3>
<div class="paragraph">
<p><strong>Distributed Tracing</strong> involves propagating the tracing context from service to service by sending certain incoming HTTP headers downstream to outbound requests. To do this, services need some hints to tie together the entire trace. They need to propagate the appropriate HTTP headers so that when the proxies send span information, the spans can be correlated correctly into a single trace.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s enable Distributed Context Propagation from the <strong>Gateway Service</strong>.</p>
</div>
<div class="paragraph">
<p>First, you are going to intercept the following header creating by <strong>Service Mesh</strong> in order to add them into the outbound requests:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>x-request-id</p>
</li>
<li>
<p>x-b3-traceid</p>
</li>
<li>
<p>x-b3-spanid</p>
</li>
<li>
<p>x-b3-parentspanid</p>
</li>
<li>
<p>x-b3-sampled</p>
</li>
<li>
<p>x-b3-flags</p>
</li>
<li>
<p>x-ot-span-context</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In Che7, under the <strong>src/main/java</strong> directory of the <strong>gateway-vertx</strong> project,
<code><strong>create a new 'TracingInterceptor' class</strong></code> in the <strong>com.redhat.cloudnative.gateway</strong> package as following:</p>
</div>
<div class="listingblock">
<div class="title">TracingInterceptor.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.redhat.cloudnative.gateway;

import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.function.Function;
import java.util.stream.Collectors;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import io.vertx.core.Handler;
import io.vertx.ext.web.client.impl.WebClientInternal;
import io.vertx.rxjava.ext.web.RoutingContext;
import io.vertx.rxjava.ext.web.client.WebClient;

public class TracingInterceptor {
    private static final Logger LOG = LoggerFactory.getLogger(TracingInterceptor.class);

    private static final List&lt;String&gt; FORWARDED_HEADER_NAMES = Arrays.asList(
        "x-request-id",
        "x-b3-traceid",
        "x-b3-spanid",
        "x-b3-parentspanid",
        "x-b3-sampled",
        "x-b3-flags",
        "x-ot-span-context"
    );

    private static final String X_TRACING_HEADERS = "X-Tracing-Headers";

    private TracingInterceptor() {
        // Avoid direct instantiation.
    }

    static Handler&lt;RoutingContext&gt; create() {
        return rc -&gt; {
            Set&lt;String&gt; names = rc.request().headers().names();
            Map&lt;String, List&lt;String&gt;&gt; headers = names.stream()
                .map(String::toLowerCase)
                .filter(FORWARDED_HEADER_NAMES::contains)
                .collect(Collectors.toMap(
                    Function.identity(),
                    h -&gt; Collections.singletonList(rc.request().getHeader(h))
                ));
            rc.put(X_TRACING_HEADERS, headers);
            rc.next();
        };
    }

    static WebClient propagate(WebClient client, RoutingContext rc) {
        WebClientInternal delegate = (WebClientInternal) client.getDelegate();
        delegate.addInterceptor(ctx -&gt; {
            Map&lt;String, List&lt;String&gt;&gt; headers = rc.get(X_TRACING_HEADERS);
            if (headers != null) {
                LOG.info("Propagating header: {}", headers);
                headers.forEach((s, l) -&gt; l.forEach(v -&gt; ctx.request().putHeader(s, v)));
            }
            ctx.next();
        });
        return client;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, route all traffic into the <strong>TracingInterceptor</strong> handler <code><strong>by uncommenting the 'TraceInterceptor handler' configuration in the 'start()' method of the 'GatewayVerticle' class</strong></code> with the following code:</p>
</div>
<div class="listingblock">
<div class="title">GatewayVerticle.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        // Enable TraceInterceptor handler
        router.route()
            .order(-1)
            .handler(TracingInterceptor.create());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, propagate the headers from the incoming request <strong>Gateway Service</strong> to any outgoing requests <strong>Catalog Service</strong> and <strong>Inventory Service</strong> using the <strong>propagate()</strong> method from <strong>TracingInterceptor</strong> class when calling outgoing services in the <strong>products()</strong> method.</p>
</div>
<div class="listingblock">
<div class="title">GatewayVerticle.java</div>
<div class="content">
<pre>        private void products(RoutingContext rc) {
            [...]
            <span class="line-through">catalog.get("/api/catalog")</span>
            TracingInterceptor.propagate(catalog, rc).get("/api/catalog")
            [...]
            <span class="line-through">inventory.get("/api/inventory/" + product.getString("itemId"))</span>
            TracingInterceptor.propagate(inventory, rc).get("/api/inventory/" + product.getString("itemId"))
            [...]
        }</pre>
</div>
</div>
<div class="paragraph">
<p>Now push the new version of the source code to OpenShift.</p>
</div>
<div class="paragraph">
<p>In your {{ CHE_URL }}[Workspace^], via the command menu (Cmd+Shift+P ⌘⇧P on macOS or Ctrl+Shift+P ⌃⇧P on Windows and Linux),
<code><strong>run 'Task: Run Task&#8230;&#8203;' &#8594;  'che: oc build gateway service'</strong></code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/che-runtask.png" alt="Che - RunTask" width="500">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/che-buildgateway.png" alt="Che - Build Gateway Service" width="500">
</div>
</div>
<div class="paragraph">
<p><code><strong>Go back to Distributed Tracing menu</code></strong> from {{ KIALI_URL }}[Kiali Console^] and see the result.
Now you have the aggregated traces and it is much more better.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/jaeger-trace-delay-view.png" alt="Jaeger - Trace Delay View" width="700">
</div>
</div>
<div class="paragraph">
<p>On the left hand side, you have information like the duration.
One request takes <strong>more than 400ms</strong> which you could judge as <strong>normal</strong> but &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p><code><strong>Let’s click on a trace title bar.</strong></code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/jaeger-trace-delay-detail-view.png" alt="Jaeger - Trace Delay Detail View" width="700">
</div>
</div>
<div class="paragraph">
<p>Interesting&#8230;&#8203; The major part of a call is consuming by the <strong>Catalog Service</strong>.
So let&#8217;s have a look on its code.
<code><strong>Go through the 'catalog-spring-boot' project and find the following piece of code</strong></code>:</p>
</div>
<div class="listingblock">
<div class="title">CatalogController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ResponseBody
@GetMapping(produces = MediaType.APPLICATION_JSON_VALUE)
public List&lt;Product&gt; getAll() {
    Spliterator&lt;Product&gt; products = repository.findAll().spliterator();
    Random random = new Random();

    List&lt;Product&gt; result = new ArrayList&lt;Product&gt;();
    products.forEachRemaining(product -&gt; {
        Class&lt;Product&gt; clazz = Product.class;
        if (clazz.isInstance(product)){
            try {
                Thread.sleep(random.nextInt(10) * 10);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }
        result.add(product);
    });
    return result;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And yes, this burns your eyes, right?! Basically nobody could understand what the developer attempted to achieve but we do not have the time for that.
This piece of code is a part of the <strong>getAll()</strong> method which returns the list of all products from the database.
As you are an expert of Java 8, you are about to create a masterpiece by both simplifying the code and increasing performance.</p>
</div>
<div class="paragraph">
<p><code><strong>Replace the content of the 'getAll()' method</strong></code> as following:</p>
</div>
<div class="listingblock">
<div class="title">CatalogController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    @ResponseBody
    @GetMapping(produces = MediaType.APPLICATION_JSON_VALUE)
    public List&lt;Product&gt; getAll() {
        Spliterator&lt;Product&gt; products = repository.findAll().spliterator();
        return StreamSupport.stream(products, false).collect(Collectors.toList());
    }</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Do not forget to import the missing packages.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now let&#8217;s check and push the new version of the source code.</p>
</div>
<div class="paragraph">
<p>In your {{ CHE_URL }}[Workspace^], via the command menu (Cmd+Shift+P ⌘⇧P on macOS or Ctrl+Shift+P ⌃⇧P on Windows and Linux),
<code><strong>run 'Task: Run Task&#8230;&#8203;' &#8594;  'che: oc build catalog service'</strong></code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/che-runtask.png" alt="Che - RunTask" width="500">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/che-buildcatalog.png" alt="Che - Build Catalog Service" width="500">
</div>
</div>
<div class="paragraph">
<p>Once deployed, generate traffic to the application (<a href="http://{{" class="bare">http://{{</a> COOLSTORE_PROJECT }}.{{ APPS_HOSTNAME_SUFFIX }}[<a href="http://{{" class="bare">http://{{</a> COOLSTORE_PROJECT }}.{{ APPS_HOSTNAME_SUFFIX }}^])
then <code><strong>go back to Distributed Tracing menu</code></strong> from {{ KIALI_URL }}[Kiali Console^] and see the result.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/jaeger-trace-fixed-detail-view.png" alt="Jaeger - Trace Detail View" width="700">
</div>
</div>
<div class="paragraph">
<p>Just wonderful! You reduce the response time by a factor of 5!! You should be proud!!</p>
</div>
</div>
<div class="sect2">
<h3 id="_congratulations"><a class="anchor" href="#_congratulations"></a>CONGRATULATIONS!!!</h3>
<div class="paragraph">
<p>You make it but <strong>is the spinning top stopped or not at the end?</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/spinningtop.jpg" alt="Inception - Spinning Top" width="500">
</div>
</div>
<div class="paragraph text-center">
<p><a href="https://wallpapercave.com/wp/plK5eJm.jpg" target="_blank" rel="noopener">Source: https://wallpapercave.com/wp/plK5eJm.jpg</a></p>
</div>
<div class="paragraph">
<p>We will never know and now, it is time to go deeper again!!</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="visualize-service-mesh.html" class="query-params-link">4. Blindfolded debugging&#8230;&#8203; Not today</a></span>
  <span class="next"><a href="live-debugging.html" class="query-params-link">6. Please Help Me!</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
