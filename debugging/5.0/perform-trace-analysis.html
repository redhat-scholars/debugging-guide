<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>"Trace Within a Trace" :: OpenShift Debugging Workshop</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/course-template/debugging/5.0/perform-trace-analysis.html">
    <link rel="prev" href="visualize-service-mesh.html">
    <link rel="next" href="live-debugging.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://redhat-scholars.github.io/course-template">OpenShift Debugging Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="debugging" data-version="5.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">OpenShift Debugging Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="introduction.html">1. Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="developer-workspace.html">2. You are not alone</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="reproduce-environment.html">3. The past is relevant only as data</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="visualize-service-mesh.html">4. Blindfolded debugging&#8230;&#8203; Not today</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="perform-trace-analysis.html">5. Trace Within a Trace</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="live-debugging.html">6. Debugger, please Help Me!</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OpenShift Debugging Workshop</span>
    <span class="version">5.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">OpenShift Debugging Workshop</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">5.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">OpenShift Debugging Workshop</a></li>
    <li><a href="perform-trace-analysis.html">5. Trace Within a Trace</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/debugging-guide/edit/5.0/documentation/modules/ROOT/pages/perform-trace-analysis.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">"Trace Within a Trace"</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>20 MINUTE PRACTICE</em></p>
</div>
<div class="paragraph">
<p>Let&#8217;s perform a "Trace Within a Trace" strategy called <strong>Distributed Tracing</strong> to infiltrate the
application traces and extract valuable information to solve the issues.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_is_jaeger"><a class="anchor" href="#_what_is_jaeger"></a>What is Jaeger?</h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="imageblock">
<div class="content">
<img src="_images/jaeger-logo.png" alt="Jaeger" width="400">
</div>
</div>
<div class="paragraph">
<p><a href="https://www.jaegertracing.io" target="_blank" rel="noopener">Jaeger Tracing</a>, inspired by Dapper and OpenZipkin, is a distributed tracing system released as open source by Uber Technologies. It is used for monitoring and troubleshooting microservices-based distributed systems, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Distributed context propagation</p>
</li>
<li>
<p>Distributed transaction monitoring</p>
</li>
<li>
<p>Root cause analysis</p>
</li>
<li>
<p>Service dependency analysis</p>
</li>
<li>
<p>Performance / latency optimization</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://www.kiali.io" target="_blank" rel="noopener">Kiali</a> includes <a href="https://www.jaegertracing.io" target="_blank" rel="noopener">Jaeger Tracing</a> to provide distributed tracing out of the box.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_are_you_hidding_mrmrs_application"><a class="anchor" href="#_what_are_you_hidding_mrmrs_application"></a>What are you hidding, Mr/Mrs <strong>Application</strong>?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>From the <a href="https://kiali-istio-system.%APPS_HOSTNAME_SUFFIX%" class="params-link" target="_blank" rel="noopener">Kiali Console</a>, <code><strong>click on the 'Distributed Tracing'</strong></code> in the left navigation.</p>
</div>
<div class="paragraph">
<p>Then <code><strong>login as user%USER_ID%/%OPENSHIFT_PASSWORD% and enter the following configuration</strong></code>:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Jaeger Settings</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">istio-ingressgateway</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code><strong>Click on the 'Find Traces' button</strong></code></p>
</div>
<div class="paragraph">
<p>Now you can see the <strong>distributed traces</strong> of our application.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jaeger-query.png" alt="Jaeger - Query" width="800">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Distributed Tracing</strong> involves propagating the tracing context from service to service by sending certain
incoming HTTP headers downstream to outbound requests. To do this, services need some hints to tie together the entire trace.
They need to propagate the appropriate HTTP headers so that when the proxies send span information,
the spans can be correlated correctly into a single trace.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code><strong>On the right-hand side of a specific trace, take a look at the duration.</strong></code>
The end-to-end requests takes <strong>more than 300ms</strong> which you could judge as <strong>normal</strong> but …​
Let&#8217;s get more details <code><strong>by clicking a trace on title bar</strong></code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/jaeger-trace-details.png" alt="Jaeger - Traces View" width="900">
</div>
</div>
<div class="paragraph">
<p>Interesting &#8230;&#8203; <strong>The major part of a call is consuming by the Catalog Service</strong>.
Let’s continue the investigation on the source code side.</p>
</div>
<div class="paragraph">
<p>In your <a href="http://codeready-workspaces.%APPS_HOSTNAME_SUFFIX%" class="params-link" target="_blank" rel="noopener">Workspace</a>,
<code><strong>Examine 'com.redhat.cloudnative.catalog.CatalogController' class</strong></code> in the <strong>/projects/workshop/catalog-spring-boot/src/main</strong> directory:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/che-catalog-controller.png" alt="Catalog Controller - Java code" width="700">
</div>
</div>
<div class="paragraph">
<p>And yes, this burns your eyes, right?! There is <strong>a random pause in the execution of current thread</strong> (<em>Thread.sleep(random.nextInt(10) * 10)</em>)
and basically it is complicated to understand what the developer attempted to achieve.</p>
</div>
<div class="paragraph">
<p>This piece of code is a part of the <em>getAll()</em> method which returns the list of all products from the database.
As you are a Java expert, you are about to create a masterpiece by both simplifying the code and increasing performance.</p>
</div>
<div class="paragraph">
<p>To fix it, we will use a new tool called <a href="https://github.com/Maistra/istio-workspace" target="_blank" rel="noopener">Istio Workspace</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_is_istio_workspace"><a class="anchor" href="#_what_is_istio_workspace"></a>What is Istio Workspace?</h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><a href="https://github.com/Maistra/istio-workspace" target="_blank" rel="noopener">Istio Workspace</a> is a tool that let you safely develop and test on any kubernetes cluster without distracting others.</p>
</div>
<div class="paragraph">
<p>The key value proposition is to allow you run service you are working on locally but interact with the other services running in the cluster.</p>
</div>
<div class="paragraph">
<p>This way you can use your favourite tools and avoid making your machine sweating from trying to run "the whole cloud" where your application is deployed.</p>
</div>
<div class="paragraph">
<p>Additionally, you can develop and test your changes without interfering with other users. Only you would be able to see your changes before they hit the production.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Do you have confidence that your Test and Stage environments reflect reality?</p>
</li>
<li>
<p>Are they easy to keep up-to-date with production?</p>
</li>
<li>
<p>Can you reproduce production failure in these environments or locally?</p>
</li>
<li>
<p>What about that error you keep seeing on production that’s never occurring on Test or Stage?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It has been always hard to test new functionality before it reaches production. Even more so, with the shift from a <strong>monolith</strong> to <strong>microservices</strong> and increasing scale.
It is practically impossible to spin up the entire solution on your laptop to debug and test a suspicious piece of code. Testing on production is no longer a meme. It’s reality and a necessity.</p>
</div>
<div class="paragraph">
<p>This project works with Istio and Kubernetes or Openshift to give you confidence that your changes won’t blow up production cluster and your users won’t even notice a glitch.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_route_the_traffic_on_your_local_workspace"><a class="anchor" href="#_route_the_traffic_on_your_local_workspace"></a>Route the traffic on your local workspace</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First we have to fix the problem. `<strong>Replace the content of the 'getAll()' method</strong>`as following:</p>
</div>
<div class="listingblock copypaste">
<div class="title">CatalogController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ResponseBody
@GetMapping(produces = MediaType.APPLICATION_JSON_VALUE)
public List&lt;Product&gt; getAll() {
    System.out.println("&gt;&gt;&gt;&gt; getAll, but faster");
    Spliterator&lt;Product&gt; products = repository.findAll().spliterator();
    return StreamSupport.stream(products, false).collect(Collectors.toList());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With those changes in place we can now test it. But does it mean we have to go through the whole <strong>build and test locally &#8594; deploy and test on OpenShift</strong> cycle?
That can take a couple of minutes. Luckily, with <a href="https://github.com/Maistra/istio-workspace" target="_blank" rel="noopener">Istio Workspace</a>, we can now start service with our changes locally,
but in a way like it would be running as part of the application in OpenShift.</p>
</div>
<div class="paragraph">
<p>In your <a href="http://codeready-workspaces.%APPS_HOSTNAME_SUFFIX%" class="params-link" target="_blank" rel="noopener">Workspace</a>,</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_ide-task"></a>IDE Task</p>
</li>
<li>
<p><a id="tabset1_cli"></a>CLI</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_ide-task">
<div class="paragraph">
<p><code><strong>Click on 'Terminal' &#8594; 'Run Task&#8230;&#8203;' &#8594;  'Catalog - Route Traffic to local'</strong></code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/che-runtask.png" alt="Che - RunTask" width="500">
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_cli">
<div class="paragraph">
<p><code><strong>Execute the following commands in the '&gt;_ workshop_tools' terminal window</strong></code></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To open a '&gt;_ workshop_tools' terminal window, <code><strong>click on 'Terminal' &#8594; 'Open Terminal in specific container' &#8594;  'workshop-tools'</strong></code>
</td>
</tr>
</table>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">cd /projects/workshop/catalog-spring-boot
ike develop \
    --deployment catalog-v1 \
    --run 'mvn spring-boot:run' \
    --port 9000:8080 \
    --route header:ike-session-id=dist_trace</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
you kill all current <strong>ike</strong> process with the command: <code>pkill ike</code>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This command will deploy a new version of the service which you can access by using special routing header.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/new-catalog-service.png" alt="New Catalog Deployed" width="700">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_the_new_version"><a class="anchor" href="#_test_the_new_version"></a>Test the new version</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As we have our improved service already up and running, it&#8217;s time to test the new version.
You can now access application through web interface by adding <strong>/?route=dist_trace</strong> query parameter
to the URL of deployed app:</p>
</div>
<div class="listingblock copypaste">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">http://web-staging-project%USER_ID%.%APPS_HOSTNAME_SUFFIX%/#!/?route=dist_trace</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>route=dist_trace</strong> is not automatically added by Istio Workspace.
This parameter, like any other should be handled (and appropriately propagated) by the application itself.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>From <a href="https://kiali-istio-system.%APPS_HOSTNAME_SUFFIX%" class="params-link" target="_blank" rel="noopener">Kiali</a>, in the <strong>'Graph' view</strong>, <code><strong>check the new traffic</strong></code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/kiali-catalog-routed.png" alt="Catalog - Route Ike" width="700">
</div>
</div>
<div class="paragraph">
<p>The traffic is directed to the new version of the Catalog service, but will keep all the other users still relying on the last deployed version.
Sadly, they will be still affected by the performance regression we just fixed.</p>
</div>
<div class="paragraph">
<p>We can also see directly in the console of your <a href="http://codeready-workspaces.%APPS_HOSTNAME_SUFFIX%" target="_blank" rel="noopener">Workspace</a>, that our service has been accessed, as we are printing a test message every single time <code><strong>CatalogController</strong></code> is accessed now.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ike-develop-catalog-hit.png" alt="Accessing new version of Catalog Service in Che" width="700">
</div>
</div>
<div class="paragraph">
<p>Moreover, we can see improvements in the response time as well:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/ike-develop-catalog-hit-jaeger.png" alt="New traces" width="800">
</div>
</div>
<div class="paragraph">
<p>Just wonderful! You reduced the response time by a factor of 5! You should be proud!</p>
</div>
<div class="paragraph">
<p>Now, it is time to go deeper again!!</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="visualize-service-mesh.html" class="query-params-link">4. Blindfolded debugging&#8230;&#8203; Not today</a></span>
  <span class="next"><a href="live-debugging.html" class="query-params-link">6. Debugger, please Help Me!</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
