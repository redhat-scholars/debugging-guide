<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Untitled :: OpenShift Debugging Workshop</title>
    <link rel="canonical" href="https://redhat-scholars.github.io/course-template/debugging/5.0/visualize-service-mesh.html">
    <link rel="prev" href="reproduce-environment.html">
    <link rel="next" href="perform-trace-analysis.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://redhat-scholars.github.io/course-template">OpenShift Debugging Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="debugging" data-version="5.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">OpenShift Debugging Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="introduction.html">1. Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="developer-workspace.html">2. You are not alone</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="reproduce-environment.html">3. The past is relevant only as data</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="visualize-service-mesh.html">4. Blindfolded debugging&#8230;&#8203; Not today</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="perform-trace-analysis.html">5. Trace Within a Trace</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="live-debugging.html">6. Please Help Me!</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">OpenShift Debugging Workshop</span>
    <span class="version">5.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">OpenShift Debugging Workshop</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">5.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">OpenShift Debugging Workshop</a></li>
    <li><a href="visualize-service-mesh.html">4. Blindfolded debugging&#8230;&#8203; Not today</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-scholars/debugging-guide/edit/5.0/documentation/modules/ROOT/pages/visualize-service-mesh.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<div class="sect1">
<h2 id="_bird_box_not_today"><a class="anchor" href="#_bird_box_not_today"></a>"Bird Box"&#8230;&#8203; Not Today!!</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>15 MINUTES PRACTICE</em></p>
</div>
<div class="paragraph">
<p>The <strong>Mysterious Application</strong> in your <strong>Developer Workspaces</strong> is now up and running. It is composed of several components, but so far, you have no clue about how the application is working.
Going all over this application and debugging it completely blindfolded is time consuming and a crazy bid as Malorie does in <strong>Bird Box</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/birdbox.png" alt="BirdBox" width="500">
</div>
</div>
<div class="paragraph text-center">
<p><a href="https://ewedit.files.wordpress.com/2019/01/bird_box_018.jpg" target="_blank" rel="noopener">Source: https://ewedit.files.wordpress.com/2019/01/bird_box_018.jpg</a></p>
</div>
<div class="paragraph">
<p>Red Hat OpenShift Container Platform provides services to get observability of applications and to understand how different components are interacting with each other.</p>
</div>
<hr>
<div class="sect2">
<h3 id="_what_is_kiali"><a class="anchor" href="#_what_is_kiali"></a>What is Kiali?</h3>
<div class="sidebarblock">
<div class="content">
<div class="imageblock">
<div class="content">
<img src="_images/images/kiali.png" alt="Kiali" width="400">
</div>
</div>
<div class="paragraph">
<p>A Microservice Architecture breaks up the monolith into many smaller pieces that are composed together. Patterns to secure the communication between services like fault tolerance (via timeout, retry, circuit breaking, etc.) have come up as well as distributed tracing to be able to see where calls are going.</p>
</div>
<div class="paragraph">
<p>A service mesh can now provide these services on a platform level and frees the application writers from those tasks. Routing decisions are done at the mesh level.</p>
</div>
<div class="paragraph">
<p><a href="https://www.kiali.io" target="_blank" rel="noopener">Kiali</a> works with Istio, in OpenShift or Kubernetes, to visualize the service mesh topology, to provide visibility into features like circuit breakers, request rates and more. It offers insights about the mesh components at different levels, from abstract Applications to Services and Workloads.</p>
</div>
</div>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_kiali_please_tell_me_how_is_the_application_working"><a class="anchor" href="#_kiali_please_tell_me_how_is_the_application_working"></a>"Kiali, please tell me, how is the application working?"</h3>
<div class="paragraph">
<p>Kiali provides an interactive graph view of your namespace in real time, being able to display the interactions at several levels (applications, versions, workloads), with contextual information and charts on the selected graph node or edge.</p>
</div>
<div class="paragraph">
<p>First, you need to access to Kiali.
<code><strong>Launch a browser and navigate to {{ KIALI_URL }}[Kiali Console^] and log in as {{ OPENSHIFT_USER }}/{{ OPENSHIFT_PASSWORD }}</strong></code></p>
</div>
<div class="paragraph">
<p>After you log in, <code><strong>click on 'Graph'</code></strong> in the left navigation and enter the following configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Namespace: <strong>{{ COOLSTORE_PROJECT }}</strong></p>
</li>
<li>
<p>Display: <strong>check 'Traffic Animation'</strong></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/kiali-graph.png" alt="Kiali - Graph" width="700">
</div>
</div>
<div class="paragraph">
<p>This page shows a graph with all the microservices, connected by the requests going through them. On this page, you can see how the services interact with each other.</p>
</div>
<div class="paragraph">
<p>Even if the application <strong>seemed</strong> working fine, there is a problem in the <strong>Gateway Service</strong> which sends a <strong>4xx http error</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/kiali-4xx.png" alt="Kiali - 4xx" width="300">
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In order to get the previous screen, please reload the <strong>Web UI</strong> more than one time!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Open the Javascript Console from your browser, and you will find a <strong>404 error</strong> when calling the <strong>'gateway/api/cart'</strong> API.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/gateway-cart-missing.png" alt="Gateway Error" width="700">
</div>
</div>
<div class="paragraph">
<p>Indeed, when you check the APIs exposed by the <strong>Gateway Service</strong>, you cannot find any <strong>'/api/cart/id-*'</strong> one.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s fix it!!</p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_build_and_deploy_the_quarkus_microservice_the_cart_service"><a class="anchor" href="#_build_and_deploy_the_quarkus_microservice_the_cart_service"></a>Build and deploy the Quarkus microservice, the Cart Service</h3>
<div class="paragraph">
<p><a href="https://quarkus.io/" target="_blank" rel="noopener">Quarkus</a> is a Kubernetes Native Java stack tailored for GraalVM &amp; OpenJDK HotSpot, crafted from the best of breed Java libraries and standards.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Architectured for running in serverless and container environments like Knative and OpenShift.</p>
</li>
<li>
<p>Designed around a <strong>container first philosophy</strong>, what this means in real terms is that Quarkus is optimised for low memory usage and fast startup times.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We already compiled the Cart Service application to a native executable called <strong>cart-1.0-SNAPSHOT-runner</strong>. You can find in the <strong>cart-quarkus</strong> project under the <strong>src/target</strong> folder. It improves the startup time of the <strong>Cart Service</strong>, and produces a minimal disk footprint. The executable would have everything to run the application including the "JVM" and the application.</p>
</div>
<div class="paragraph">
<p>In this chapter, you will focus on creating a Docker image using the produced native executable.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/containerization-process.png" alt="Quarkus - Container" width="700">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you want, take a moment to examine the source code of the Cart Service implemented with <a href="https://quarkus.io/" target="_blank" rel="noopener">Quarkus</a>.
You can find it under the package <strong>com.redhat.cloudnative</strong> in the <strong>src/main/java</strong> directory of the <strong>cart-quarkus</strong> project.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In your {{ CHE_URL }}[Workspace^], open a new Terminal with OpenShift tools by <code><strong>clicking
on the 'My Workspace' white box in the right menu, then 'Plugins' &#8594; 'vscode-openshift-connector' &#8594; '&gt;_ New terminal'</strong></code>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/che-open-openshift-terminal.png" alt="Che - Open OpenShift Terminal" width="700">
</div>
</div>
<div class="paragraph">
<p>In the window called <strong>'&gt;_ vscode-openshift-connector terminal'</strong>, <code><strong>execute the following commands</strong></code>:</p>
</div>
<div class="listingblock">
<div class="title">&gt;_ vscode-openshift-connector terminal</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># To build the image on OpenShift
$ oc new-build --binary --name=cart -lapp=cart,version=v1.0
$ oc patch bc/cart -p '{"spec":{"strategy":{"dockerStrategy":{"dockerfilePath":"src/main/docker/Dockerfile"}}}}'
$ oc start-build cart --from-dir /projects/labs/cart-quarkus --follow

# To instantiate the image
$ oc new-app --image-stream=cart:latest -lapp=cart,version=v1.0

# To deploy an Istio SideCar and configure Catalog Service Deployment
$ oc rollout pause dc/cart
$ oc patch dc/cart --patch '{"spec": {"template": {"metadata": {"annotations": {"sidecar.istio.io/inject": "true"}}}}}'
$ oc set env dc/cart CATALOG_ENDPOINT=http://catalog:8080
$ oc rollout resume dc/cart</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/console-cart.png" alt="Openshift Console Cart" width="800">
</div>
</div>
<div class="paragraph">
<p><strong>YOU HAVE TO SEE THAT!</strong>
Have a look to the log of the <strong>Cart Service</strong> pod by cliking in the dark blue circle and then <strong>just admire its amazing FAST BOOT TIME!</strong></p>
</div>
<div class="listingblock">
<div class="title">Cart Service logs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">2019-04-01 20:13:35,623 INFO  [io.quarkus] (main) Quarkus 0.11.0 started in 0.009s. Listening on: http://0.0.0.0:8080
2019-04-01 20:13:35,623 INFO  [io.quarkus] (main) Installed features: [cdi, resteasy, resteasy-jsonb, smallrye-rest-client]
2019-04-01 20:17:08,790 INFO  [com.red.clo.ser.ShoppingCartService] (XNIO-1 task-1) Using local cache for cart data</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>AND YES, IT&#8217;S A JAVA APPLICATION!</strong></p>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_update_gateway_service"><a class="anchor" href="#_update_gateway_service"></a>Update Gateway Service</h3>
<div class="paragraph">
<p>Previously, we deployed the <strong>Cart Service</strong>. Now, you have to take it in account in the <strong>Gateway Service</strong>.</p>
</div>
<div class="paragraph">
<p>Under the <strong>/projects/labs/gateway-vertx</strong> project, <code><strong>uncomment the '/api/cart/:cardId' route in the 'start()' method of the 'GatewayVerticle' class</strong></code> as following:</p>
</div>
<div class="listingblock">
<div class="title">GatewayVerticle.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        // Cart Route
        router.get("/api/cart/:cardId").handler(this::getCartHandler);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In your {{ CHE_URL }}[Workspace^], via the command menu (Cmd+Shift+P ⌘⇧P on macOS or Ctrl+Shift+P ⌃⇧P on Windows and Linux),
<code><strong>run 'Task: Run Task&#8230;&#8203;' &#8594;  'che: oc build gateway service'</strong></code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/che-runtask.png" alt="Che - RunTask" width="500">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/che-buildgateway.png" alt="Che - Build Gateway Service" width="500">
</div>
</div>
<div class="paragraph">
<p>Once deployed, check your javascript console that the <strong>404 error</strong> has disappeared.
In Kiali Graph, the <strong>Gateway Service</strong> is now green and you can see the new <strong>Cart Service</strong> is now present!</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/images/gateway-cart-fixed.png" alt="Gateway Fixed" width="700">
</div>
</div>
<hr>
</div>
<div class="sect2">
<h3 id="_congratulations"><a class="anchor" href="#_congratulations"></a>CONGRATULATIONS!!!</h3>
<div class="paragraph">
<p>You survive and you put off the blindfold on your own. But it is not THE END&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Now, let&#8217;s go deeper!!</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="reproduce-environment.html" class="query-params-link">3. The past is relevant only as data</a></span>
  <span class="next"><a href="perform-trace-analysis.html" class="query-params-link">5. Trace Within a Trace</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
